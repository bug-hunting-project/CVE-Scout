from flask import request
from flask_restx import Namespace, Resource, reqparse


def cve(sqlite_client):
    api = Namespace("cve", description="CVE 관련 API")
    PAGE_SIZE = 2000

    @api.route("/all")
    class CveAllList(Resource):
        @api.doc(
            params={
                "page": {
                    "description": "가져올 페이지 번호입니다. 결과를 페이지별로 나누는 데 사용됩니다.",
                    "type": "int",  # 데이터 타입을 명시합니다.
                    "required": False,  # 필수 파라미터인지 여부를 명시합니다.
                    "default": 1  # 기본값을 명시합니다.
                }
            },
            responses={200: "Success"}, 
            description="MongoDB에 저장된 모든 CVE ID 리스트 출력"
        )
        def get(self):
            page = int(request.args.get('page', 1))
            if page <= 0:
                page = 1
            
             # SQLite 데이터베이스에 연결
            cursor = sqlite_client.cursor()
            
             # 전체 CVE 항목 수를 가져옵니다.
            cursor.execute("SELECT COUNT(id) FROM vulnerability_metadata WHERE namespace LIKE 'nvd:cpe'")
            total_cves = cursor.fetchone()[0]

            offset = (page - 1) * PAGE_SIZE

            cve_data = []
            cursor.execute(f"SELECT id FROM vulnerability_metadata WHERE namespace LIKE 'nvd:cpe' LIMIT {PAGE_SIZE} OFFSET {offset}")
            for row in cursor.fetchall():
                cve_data.append(row[0])

            # 데이터베이스 연결을 닫습니다.
            cursor.close()

            return {"cve": cve_data, "page": page, "total_pages": (total_cves + PAGE_SIZE - 1) // PAGE_SIZE}, 200

    @api.route("/<int:year>")
    class CveYearList(Resource):
        @api.doc(
            params={"year": "Year of the CVE"},
            responses={200: "Success"},
            description="MongoDB에 저장된 특정 연도의 CVE ID 리스트 출력",
        )
        def get(self, year):
            cve_data = []
            
            # SQLite 쿼리를 실행하여 CVE ID를 가져옵니다.
            cursor = sqlite_client.cursor()
            cursor.execute(f"SELECT id FROM vulnerability_metadata WHERE namespace LIKE 'nvd:cpe' AND id LIKE 'CVE-{year}-%'")
            for row in cursor.fetchall():
                cve_data.append(row[0])

            # 데이터베이스 연결을 닫습니다.
            cursor.close()

            return {"cve": cve_data}, 200

    @api.route("/detail/<string:cve_id>")
    class CveDetail(Resource):
        @api.doc(
            params={"cve_id": "CVE ID"},
            responses={200: "Success", 404: "CVE not found"},
            description="MongoDB에 저장된 특정 CVE의 정보 출력",
        )
        def get(self, cve_id):
            cursor = sqlite_client.cursor()

            # SQLite 쿼리를 실행하여 CVE 정보를 가져옵니다.
            cursor.execute(
                f"SELECT id, Namespace, data_source, severity, urls, description, cvss FROM vulnerability_metadata WHERE namespace LIKE 'nvd:cpe' AND id LIKE '{cve_id}'"
            )
            cve_data = cursor.fetchone()
            
            if cve_data:
                # 결과를 딕셔너리로 변환합니다.
                keys = ["id", "Namespace", "data_source", "severity", "urls", "description", "cvss"]
                cve_info = dict(zip(keys, cve_data))
            else:
                return {"error": "CVE not found"}, 404
            
            cursor.execute("SELECT * FROM kev WHERE cveID=?", (cve_id,))
            kev_data = cursor.fetchall()
            
            if kev_data:
                # 결과를 딕셔너리로 변환합니다.
                keys = ["vendorProject", "product", "vulnerabilityName", "dateAdded", "shortDescription", "requiredAction", "dueDate", "notes"]
                kev_info = [dict(zip(keys, item[1:])) for item in kev_data]
            else:
                kev_info = "Null"
            # 데이터베이스 연결을 닫습니다.
            cursor.close()

            return {"CVE": cve_info, "KEV": kev_info}, 200
    
    parser = reqparse.RequestParser()
    parser.add_argument('count', type=int, help='count만큼의 최신 CVE ID 출력')

    @api.route("/detail/latest")
    class CveLatest(Resource):
        @api.doc(
            params={"count": "CVE ID를 가져올 갯수"},
            responses={200: "Success", 404: "CVE not found"},
            description="count만큼의 최신 CVE ID 출력",
        )
        def get(self):
            args = parser.parse_args()
            count = args['count']
            
            cursor = sqlite_client.cursor()
            cursor.execute("SELECT id FROM vulnerability ORDER BY pk DESC LIMIT ?", (count,))
            cve_list = [item[0] for item in cursor.fetchall()] 
            
            return {"latest": cve_list}, 200

    return api
