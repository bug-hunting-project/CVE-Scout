import os
import sqlite3
import csv

class Sqlite_Handler:
    def __init__(self, db_path):
        # if not os.path.exists(db_path):
        #     print(f"Warning: Database file {db_path} not found. It will be created upon initialization.")
        self.db_path = db_path
        
        self.db_conn = sqlite3.connect(self.db_path)
        self.cursor = self.db_conn.cursor()
    
    def table_exists(func):
        def wrapper(self, table_name, *args, **kwargs):
            check_query = f"SELECT name FROM sqlite_master WHERE type='table' AND name='{table_name}';"
            self.cursor.execute(check_query)
            if bool(self.cursor.fetchone()):
                print(f"Error: Table {table_name} does not exist.")
                return False
            return func(self, table_name, *args, **kwargs)
        return wrapper
    
    @table_exists
    def create_table(self, table_name, schema):
        columns_list = [f"{column_name} {data_type}" for column_name, data_type in schema.items()]
        create_query = f"CREATE TABLE {table_name}({', '.join(columns_list)})"
        self.cursor.execute(create_query)
        return True

    def delete_table(self, table_name):
        try:
            delete_query = f"DROP TABLE {table_name};"
            self.cursor.execute(delete_query)
            return True
        except sqlite3.OperationalError as e:
            print(f"Error occurred while trying to delete table {table_name}: {str(e)}")
            return False
    
    @staticmethod
    def wget_download_csv(csv_url, csv_path):
        os.system(f"wget -q {csv_url} -O {csv_path} 1>/dev/null")
    
    def import_csv(self, csv_path, table_name, schema):
        with open(csv_path, 'r') as file:
            csv_reader = csv.reader(file)
            next(csv_reader)
            
            column_names = ', '.join(schema.keys())
            placeholders = ', '.join(['?'] * len(schema))
            insert_query = f"INSERT INTO {table_name}({column_names}) VALUES ({placeholders})"
            
            try:
                for row in csv_reader:
                    self.cursor.execute(insert_query, row)
                self.db_conn.commit()  # Commit changes to the database
                return True
            except Exception as e:
                print(f"Error occurred while importing CSV: {str(e)}")
                return False
            
if __name__ == "__main__":
    Sqlite_Handler.wget_download_csv(csv_url="https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv", csv_path="/home/lrtk/project/CVE-Scout/test/kev.csv")
    
    # Initialize handler
    handler = Sqlite_Handler("/home/lrtk/.cache/grype/db/5/vulnerability.db")
    
    
    # Define a test schema
    schema = {
        'cveID': 'TEXT',
        'vendorProject': 'TEXT',
        'product': 'TEXT',
        'vulnerabilityName': 'TEXT',
        'dateAdded': 'DATE',
        'shortDescription': 'TEXT',
        'requiredAction': 'TEXT',
        'dueDate': 'DATE',
        'notes': 'TEXT'
    }

    # Create a new table
    # if handler.create_table("kev", schema):
    #     print("Successfully created table.")
    # else:
    #     print("Failed to create table or table already exists.")

    # print(handler.import_csv(
    #     csv_path="/home/lrtk/project/CVE-Scout/test/kev.csv", 
    #     table_name="kev", 
    #     schema=schema
    # ))

    # Delete the table
    # if handler.delete_table("kev"):
    #     print("Successfully deleted table.")
    # else:
    #     print("Failed to delete table or table does not exist.")
